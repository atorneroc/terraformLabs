1. Crear los archivos main, output, provider, variables

2. Crear manualmente estos recursos en azurerm
# 1Ô∏è‚É£ Grupo de recursos del backend
az group create -n rg-tfstate -l eastus

# 2Ô∏è‚É£ Storage account √∫nico global (usa min√∫sculas y sin guiones)
az storage account create \
  -n scharfftstate \
  -g rg-tfstate \
  -l eastus \
  --sku Standard_LRS

# 3Ô∏è‚É£ Contenedor para los estados
az storage container create \
  -n tfstate \
  --account-name scharfftstate

3. ejecutar estos comandos

#Inicializa el proyecto Terraform (descarga proveedores, m√≥dulos y configura el backend).
#Con -reconfigure, ignora cualquier configuraci√≥n anterior (por ejemplo, si cambiaste el backend o Storage del state) y reestablece la conexi√≥n desde cero.
terraform init -reconfigure -backend-config="backend/backend.dev.tfvars"
#Formatea autom√°ticamente los archivos .tf seg√∫n el estilo oficial de HashiCorp (indentaci√≥n, espacios, etc.).
terraform fmt
#Revisa que los archivos .tf sean v√°lidos sint√°cticamente y estructuralmente.
#Verifica que las referencias entre recursos, variables y outputs sean correctas.
#No conecta con Azure (solo analiza la l√≥gica local).
terraform validate
#Calcula qu√© acciones ejecutar√° Terraform comparando el estado actual (local o remoto) con tu c√≥digo .tf.
#Muestra un resumen tipo:
#Plan: 3 to add, 0 to change, 0 to destroy.
terraform plan -var-file="vars/terraform.dev.tfvars"

4. Si est√° todo OK el terraform plan, ejecutar el siguiente comando.
#Aplica los cambios reales en Azure (crea, actualiza o elimina recursos seg√∫n el plan).
#El flag -auto-approve omite la confirmaci√≥n manual (√∫til en entornos CI/CD o pruebas locales).
#En producci√≥n, normalmente no se usa el -auto-approve (para forzar revisi√≥n manual).
terraform apply -var-file="vars/terraform.dev.tfvars" -auto-approve

5. en resumen, estos son los comnandos


#terraform init -reconfigure -backend-config="backend/backend.dev.tfvars"
terraform init -reconfigure -upgrade -backend-config="backend/backend.dev.tfvars"
terraform fmt
terraform validate
terraform plan -var-file="vars/terraform.dev.tfvars"
terraform apply -var-file="vars/terraform.dev.tfvars" -auto-approve


6. Para eliminar todo lo creado por Terraform ejecutar el siguiente comando
terraform init -reconfigure -backend-config="backend/backend.dev.tfvars"
terraform destroy -var-file="vars/terraform.dev.tfvars" -auto-approve


#COMANDOS ESENCIALES PARA VALIDACI√ìN Y DEPURACI√ìN
#1Ô∏è‚É£ Verificar configuraci√≥n del contenedor
az webapp config container show --name app-nsf-dev --resource-group rg-terraform-lab-dev
#‚úÖ Te muestra la imagen configurada (dockerCustomImageName, dockerRegistryUrl, acrUseManagedIdentityCreds).


#2Ô∏è‚É£ Verificar logs en vivo del App Service
az webapp log tail --name app-nsf-dev --resource-group rg-terraform-lab-dev
#‚úÖ √ötil para confirmar si la imagen se descarg√≥ o fall√≥ (Pull Image successful o ImagePullFailure).


#3Ô∏è‚É£ Obtener el principalId (identidad del App Service)
az webapp identity show --name app-nsf-dev --resource-group rg-terraform-lab-dev
#‚úÖ Muestra el ID de la identidad administrada (principalId), que se usa para asignar el rol AcrPull.


#4Ô∏è‚É£ Validar el rol AcrPull asignado
az role assignment list --all --assignee $(az webapp identity show --name app-nsf-dev --resource-group rg-terraform-lab-dev --query principalId -o tsv) --output table
#‚úÖ Confirma que el App Service tiene el rol AcrPull sobre tu ACR.


#5Ô∏è‚É£ Verificar que la autenticaci√≥n con identidad est√© activa
az webapp show --name app-nsf-dev --resource-group rg-terraform-lab-dev --query "siteConfig.acrUseManagedIdentityCreds"
#‚úÖ Debe devolver true (si es false, el App Service no puede autenticarse en el ACR).


#6Ô∏è‚É£ Confirmar que la imagen configurada coincide con la subida al ACR
az acr repository show-tags --name acrnsfdevatornero --repository nginx -o table
#‚úÖ Verifica que el tag (latest en tu caso) existe realmente en el ACR.


#7Ô∏è‚É£ Forzar un reinicio del App Service
az webapp restart --name app-nsf-dev --resource-group rg-terraform-lab-dev
#‚úÖ Refresca la configuraci√≥n y fuerza un nuevo pull desde el ACR.



#üí° Comandos opcionales (solo si hay error)
#Si alguna vez acrUseManagedIdentityCreds vuelve a false por alg√∫n cambio, puedes reactivar manualmente:
az resource update --ids $(az webapp show --name app-nsf-dev --resource-group rg-terraform-lab-dev --query id -o tsv) --set properties.acrUseManagedIdentityCreds=true